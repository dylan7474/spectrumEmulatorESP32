#!/usr/bin/env bash
# Build environment checker for the ESP32-directed Spectrum Emulator.

set -euo pipefail

missing=0
warn=0

print_status() {
    local code="$1" msg="$2"
    if [[ "$code" -eq 0 ]]; then
        printf "[OK] %s\n" "$msg"
    else
        printf "[MISSING] %s\n" "$msg"
    fi
}

print_hint() {
    case "$1" in
        arduino-cli)
            printf "  Hint: See README for the arduino-cli install/bootstrap script.\n"
            ;;
        git)
            printf "  Hint: Debian/Ubuntu -> sudo apt install git\n"
            ;;
        python3)
            printf "  Hint: Debian/Ubuntu -> sudo apt install python3\n"
            ;;
    esac
}

check_tool() {
    local tool="$1"
    if command -v "$tool" >/dev/null 2>&1; then
        print_status 0 "$tool found at $(command -v "$tool")"
    else
        print_status 1 "$tool not found"
        print_hint "$tool"
        missing=1
    fi
}

check_arduino_core() {
    if ! command -v arduino-cli >/dev/null 2>&1; then
        printf "[SKIP] Arduino toolchain checks skipped because arduino-cli is missing.\n"
        warn=1
        return
    fi

    if arduino-cli core list --format json 2>/dev/null | grep -q '"ID"\s*:\s*"esp32:esp32"'; then
        print_status 0 "arduino-cli esp32 core installed"
    else
        print_status 1 "arduino-cli esp32 core not installed"
        warn=1
    fi

    if arduino-cli lib list --format json 2>/dev/null | grep -qi '"Name"\s*:\s*"TFT_eSPI"'; then
        print_status 0 "arduino-cli TFT_eSPI library installed"
    else
        print_status 1 "arduino-cli TFT_eSPI library not installed"
        warn=1
    fi
}

printf "Checking ESP32 bring-up prerequisites...\n"

check_tool git
check_tool python3
check_tool arduino-cli
check_arduino_core

if [[ "$missing" -ne 0 ]]; then
    printf "\nOne or more required tools are missing. Please install the suggested packages and rerun ./configure.\n"
    exit 1
fi

if [[ "$warn" -ne 0 ]]; then
    printf "\nOptional ESP32 toolchain components were not fully detected. See README for installation steps.\n"
fi

printf "\nPrerequisites for the ESP32 Freenove FNK0103 bring-up are available. Proceed with Arduino CLI or ESP-IDF workflows as documented.\n"
exit 0
